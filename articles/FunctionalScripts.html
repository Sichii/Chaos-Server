<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>FunctionalScripts | Chaos Server Docs </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="FunctionalScripts | Chaos Server Docs ">
      
      <link rel="icon" href="../images/chaos.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/Sichii/Chaos-Server/blob/release/v1.9/docs/articles/FunctionalScripts.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../images/chaosico.png" alt="Chaos Server Docs">
            Chaos Server Docs
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="functionalscripts">FunctionalScripts</h1>

<p>Functional scripts are a special kind of script that is handled slightly differently than other scripts. They are used
to handle specific
kinds of interactions, and are not tied to any single entity. These scripts can be found
under <code>Chaos.Scripting.FunctionalScripts</code>.</p>
<p>These scripts often use <a href="Formulae.html">Formulae</a> for calculations as part of their actions. Any functional scripts that
utilize formulae
should be implemented in a way that the formula used is swappable for other implementations of that formula.</p>
<p>Let's use the <a class="xref" href="../api/Chaos.Scripting.FunctionalScripts.ApplyDamage.ApplyAttackDamageScript.html">DefaultApplyDamageScript</a>
functional script as
an example.</p>
<pre><code class="lang-csharp">#region
using Chaos.DarkAges.Definitions;
using Chaos.Formulae;
using Chaos.Formulae.Abstractions;
using Chaos.Models.World;
using Chaos.Models.World.Abstractions;
using Chaos.Scripting.Abstractions;
using Chaos.Scripting.FunctionalScripts.Abstractions;
#endregion

namespace Chaos.Scripting.FunctionalScripts.ApplyDamage;

public class ApplyAttackDamageScript : ScriptBase, IApplyDamageScript
{
    public IDamageFormula DamageFormula { get; set; } = DamageFormulae.Default;
    public static string Key { get; } = GetScriptKey(typeof(ApplyAttackDamageScript));

    public virtual int ApplyDamage(
        Creature source,
        Creature target,
        IScript script,
        int damage,
        Element? elementOverride = null)
    {
        damage = DamageFormula.Calculate(
            source,
            target,
            script,
            damage,
            elementOverride);

        if (damage &lt;= 0)
            return 0;

        target.Trackers.LastDamagedBy = source;

        switch (target)
        {
            case Aisling aisling:
                aisling.StatSheet.SubtractHp(damage);
                aisling.Client.SendAttributes(StatUpdateType.Vitality);
                aisling.ShowHealth();
                aisling.Script.OnAttacked(source, damage);

                if (!aisling.IsAlive)
                    aisling.Script.OnDeath();

                break;
            case Monster monster:
                monster.StatSheet.SubtractHp(damage);
                monster.ShowHealth();
                monster.Script.OnAttacked(source, damage);

                if (!monster.IsAlive)
                    monster.Script.OnDeath();

                break;
            case Merchant merchant:
                merchant.Script.OnAttacked(source, damage);

                break;
        }

        return damage;
    }

    public static IApplyDamageScript Create() =&gt; FunctionalScriptRegistry.Instance.Get&lt;IApplyDamageScript&gt;(Key);
}
</code></pre>
<p>In this class, you can see that this script is used to apply damage to a target, and uses
the <a class="xref" href="../api/Chaos.Formulae.Damage.DefaultDamageFormula.html">DefaultDamageFormula</a> to calculate the damage before it applies
it. The formula is
stored by it's interface, making it swappable with other implementations of that interface.</p>
<p>Anything that deals damage should do it through this script, rather than do it directly. This creates a single place
where changes and logic
can be made for how damage is applied.</p>
<h3 id="functional-script-construction">Functional Script Construction</h3>
<p>Functional scripts have a strange construction process. Because they generally deal with highly cross-cutting concerns,
they should
generally not be created through the IoC container. Instead, they should be created through a static factory method on
the implementation.
This static factory should reference the singleton instance of
the <a class="xref" href="../api/Chaos.Scripting.FunctionalScripts.FunctionalScriptRegistry.html">FunctionalScriptRegistry</a>. This class is
responsible for creating
functional scripts and injecting any dependencies they may have.</p>
<div class="NOTE">
<h5>Note</h5>
<p>The registry is configured at startup and automatically gathers type data for any implementations
of <a class="xref" href="../api/Chaos.Scripting.FunctionalScripts.Abstractions.IFunctionalScript.html">IFunctionalScript</a>.</p>
</div>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/Sichii/Chaos-Server/blob/release/v1.9/docs/articles/FunctionalScripts.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
